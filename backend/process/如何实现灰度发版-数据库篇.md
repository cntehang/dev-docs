# 如何实现灰度发版-数据库篇

## 1 简述

灰度发版主要的困难点在数据库和配置的变更，尤其是数据库，所以本篇主要谈谈数据库变更如何灰度发版。

## 2 什么情况不能灰度发版

发版前运行的 sql 有这些关键字，则不能灰度发版：

- drop table

- alter table ... drop column

- alter table ... change column

## 3 如何解决

- `drop table` 和 `alter table ... drop column` 都在发版完成后再执行即可。

- `alter table ... change old_column new_column` 不可直接运行，需要如下处理：
  - 发版前先运行 `alter table ... add column new_column`，保证灰度发版过程中的新版代码能正常运行；
  - 灰度发版完成；
  - 迁移老数据，`update table ... set new_column = old_column`；
  - 删除老字段，`alter table ... drop column old_column`；

> 注意：迁移老数据，一定要放在发版完成之后，因为发版的过程中也会有老数据生成。

## 4 总结

总结一下灰度发版的 sql 执行顺序：

- 发版前运行 sql：建表、加字段等；

- 完成灰度发版；

- 发版后再运行 sql：先迁移数据，再删除废表、删除废弃字段。
