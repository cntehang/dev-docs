# Code Review

## 1 基本原则

- 代码审查是最有效率的质量改善工具。比各种测试都有效。
- 代码审查能减少出现安全问题的可能性。
- 审查者要像自己写代码一样，确认阅读和理解每一行语句。
- 如果审查者和程序员不能达成一致，由团队其他人协调。

## 2 前置说明

- 在讲如何 review pr 之前，先简单说说怎么提 pr，这会让 review 变得更加容易。

### 2.1 如何提 pr

- pr title：概括一下做了什么
- pr comment：
  - 一条条列举做了哪些事情
  - 如果有需求链接、缺陷链接，请张贴出来
  - 必要的话可以上传截图

## 3 审查的颗粒度

- 审查的代码量可以很小，但是最大不能超过一周代码的上限。
- 对于小需求和缺陷修复，以可以验证或操作的功能为单位进行审查。
- 如果对三天或以上的代码量审查，需要提前 24 小时找到审查者并告知可能的审查工作量。

## 4 检查事项

### 4.1 指导思想

- 认真阅读和理解每一行代码，如同自己重写一遍。
- 所有的建议和讨论都在 PR 上面保留。

### 4.2 可用性 review

- 代码可以编译、可以 Merge。不可以就停止审查。
- 如果有可验证的用户界面，先操作界面完成所需功能。不对就停止审查。

### 4.3 设计文档 review

- 为提高审查效率，先理解高层的代码设计和实现功能。
- 复杂的代码模块是否有设计文档，没有就停止审查。
- 相关的需求或设计文档是否同步更新，没有就停止审查。

### 4.4 测试代码 review

- 代码是否有关键模块的单元测试，核心流程的集成测试。没有就停止审查。

### 4.5 安全性 review

#### 4.5.1 接口安全

- 接口入参
  - 非表单填写的数据，不信任前端传值，后端自己从数据库取。
- 接口返回
  - 接口不该给前台客户的数据不应该暴露，比如成本价格等。
  - 敏感字段脱敏。
- 接口鉴权
  - 只能访问自己能看到的数据
  - 高权限能访问低权限的数据
  - 不能横向越权

#### 4.5.2 数据库安全

- 检查是否有 sql 注入的风险
- 仔细检查 delete 相关的业务逻辑

### 4.6 发版 sql review

- delete 语句好好检查，要有站得住脚的理由。
- update 语句检查是否有类似全表更新这样的危险操作，同样要有站得住脚的理由。
- update 语句 where 条件检查，看是否会造成锁表。
- 检查是否能灰度发版，判断方式比较复杂，参考：[如何实现灰度发版-数据库篇.md](./如何实现灰度发版-数据库篇.md)
